# Gwxapkg

<div align="center">

![Version](https://img.shields.io/badge/version-2.5.0-blue.svg)
![Go Version](https://img.shields.io/badge/go-%3E%3D1.21-00ADD8.svg)
![License](https://img.shields.io/badge/license-MIT-green.svg)
![Platform](https://img.shields.io/badge/platform-macOS%20%7C%20Windows%20%7C%20Linux-lightgrey.svg)
![Build](https://img.shields.io/badge/build-passing-brightgreen.svg)

**[中文](README.md) | [English](README_EN.md) | [日本語](README_JA.md)**

Go言語で構築されたWeChatミニプログラム `.wxapkg` 解凍ツール。自動スキャン、復号化、逆コンパイル、セキュリティ分析機能を搭載。

</div>

---

## ✨ 主な機能

### 🔍 スマート解凍
- **自動スキャン** - macOS/WindowsのWeChatミニプログラムキャッシュディレクトリを自動検出
- **自動復号化** - 暗号化されたwxapkgファイルの復号化をサポート（PC版）
- **ワンクリック処理** - 指定されたAppIDのすべてのファイルを自動検索・処理
- **サブパッケージ処理** - メインパッケージとサブパッケージの依存関係を正しく処理

### 🎨 コード復元
- **完全復元** - wxml/wxss/js/json/wxsを完全サポート
- **コード整形** - JavaScript/CSS/HTMLコードの自動フォーマット
- **ディレクトリ構造** - WeChat ミニプログラムの元のプロジェクト構造を復元
- **リソース抽出** - 画像/音声/動画リソースの完全抽出

### 🔒 セキュリティ分析 ⭐ NEW
- **スマートスキャン** - 200以上の機密情報検出ルール
- **誤検知フィルタリング** - インテリジェントブラックリスト、誤検知率を95%から10-15%に削減
- **データ重複排除** - 重複データを自動削除し、精密に特定
- **Excelレポート** - ファイルパスと行番号を含むプロフェッショナルなマルチシート分類レポート
- **リスク分類** - 高/中/低リスクの自動分類

### ⚡ パフォーマンス最適化
- **動的並行処理** - CPUコア数に基づいて並行度を自動調整
- **バッファI/O** - 256KBバッファでファイル読み書き性能を大幅向上
- **ルール事前コンパイル** - 起動時に正規表現をコンパイルし、繰り返しオーバーヘッドを回避
- **ビルド最適化** - 最適化されたビルドフラグでサイズを削減し速度を向上

---

## 📊 サポートされるファイルタイプ

| ファイルタイプ | サポート | 説明 |
|--------------|---------|------|
| `.wxml` | ✅ | ページ構造の復元 |
| `.wxss` | ✅ | スタイルファイルの復元 |
| `.js` | ✅ | JavaScriptコードの復元と整形 |
| `.json` | ✅ | 設定ファイルの抽出 |
| `.wxs` | ✅ | WXSスクリプトの復元 |
| 画像/音声/動画 | ✅ | リソースファイルの完全抽出 |

---

## 📥 インストール

### 方法1：コンパイル済みバイナリをダウンロード（推奨）

[Releases](https://github.com/25smoking/Gwxapkg/releases)ページからプラットフォームに対応する実行ファイルをダウンロードしてください。

### 方法2：ソースからビルド

```bash
# リポジトリをクローン
git clone https://github.com/25smoking/Gwxapkg.git
cd Gwxapkg

# ビルド（最適化版）
go build -ldflags="-s -w" -o gwxapkg .

# または直接実行
go run . -h
```

**必要条件：** Go 1.21以上

---

## 🚀 クイックスタート

### 基本的な使い方

```bash
# AppIDを指定してミニプログラムを自動スキャン・解凍
./gwxapkg all -id=<AppID>

# 単一のwxapkgファイルを解凍
./gwxapkg -id=<AppID> -in=<ファイルパス>

# 機密情報スキャンを有効化（Excelレポート生成）
./gwxapkg all -id=<AppID> -sensitive=true
```

### コマンドパラメータ

| パラメータ | 短縮形 | 説明 | デフォルト |
|-----------|-------|------|-----------|
| `--id` | `-id` | ミニプログラムAppID（必須） | - |
| `--input` | `-in` | 入力ファイルパス | - |
| `--output` | `-out` | 出力ディレクトリ | 自動生成 |
| `--restore` | `-r` | プロジェクトディレクトリ構造を復元 | true |
| `--pretty` | `-p` | JSコードを整形 | true |
| `--sensitive` | `-s` | 機密情報スキャンを有効化 | false |

### 使用例

```bash
# 例1: すべてのファイルを解凍し機密情報をスキャン
./gwxapkg all -id=wx3c19e32cb8f31289 -sensitive=true

# 例2: 解凍のみ、コード整形なし
./gwxapkg all -id=wx123456 -pretty=false

# 例3: 指定ディレクトリに解凍
./gwxapkg -id=wx123456 -in=test.wxapkg -out=./output

# 例4: 再パッキング（変更後）
./gwxapkg pack -in=./source_dir -out=new.wxapkg
```

---

## 📁 WeChatミニプログラムのキャッシュ位置

### macOS
```
~/Library/Containers/com.tencent.xinWeChat/Data/Library/Caches/
├── applet/
│   ├── release/
│   └── debug/
└── ...
```

### Windows
```
%USERPROFILE%\Documents\WeChat Files\Applet\
├── wx<appid>/
│   ├── <version>/
│   │   ├── __APP__.wxapkg      # メインパッケージ
│   │   └── __SUBCONTEXT__.wxapkg  # サブパッケージ
│   └── ...
└── ...
```

---

## 🎯 機密情報スキャン

### スキャンルール（200以上）

| カテゴリ | ルール数 | 例 |
|---------|---------|-----|
| **パス** | 1 | ファイルパス、システムパス |
| **URL** | 2 | HTTP/HTTPSリンク、APIエンドポイント |
| **ドメイン** | 1 | ドメインアドレス（TLD検証） |
| **パスワード** | 12+ | 各種パスワード、データベース認証情報 |
| **APIキー** | 40+ | AWS/Alibaba Cloud/Tencent Cloudキー |
| **トークン** | 30+ | JWT/Bearer/OAuthトークン |
| **データベース** | 15+ | MySQL/MongoDB/Redis接続文字列 |
| **連絡先情報** | 3 | 電話番号/メール/ID番号 |
| **WeChat** | 4 | AppID/Secret/Webhook |
| **その他** | 90+ | 証明書/ハッシュ/UUIDなど |

### Excelレポート内容

生成されたレポートには以下のシートが含まれます：

- **概要** - スキャン統計、リスク分布、カテゴリ概要
- **パス** - すべてのパス関連の機密情報
- **URL** - すべてのURLとAPIエンドポイント
- **ドメイン** - ドメインアドレス（誤検知フィルタ済み）
- **パスワード** - パスワードと認証情報
- **APIキー** - 各種クラウドサービスキー
- **トークン** - アクセストークンとセッション情報
- **データベース** - データベース接続情報
- **連絡先情報** - 電話番号、メールなど
- **WeChat** - WeChat関連設定
- **その他** - その他の機密情報

各エントリには以下が含まれます：
- ✅ 内容（Content）
- ✅ 出現回数
- ✅ ファイルパス
- ✅ 行番号
- ✅ リスクレベル

---

## 📈 パフォーマンス比較（v2.5.0 vs v1.0）

| 指標 | v1.0 | v2.5.0 | 改善 |
|------|------|--------|------|
| **スキャン速度** | ベースライン | +50-70% | ⬆️⬆️⬆️ ルール事前コンパイル |
| **誤検知率** | ~95% | 10-15% | ⬇️⬇️⬇️ スマートフィルタリング |
| **データ量** | 127,185件 | ~3,000件 | ⬇️⬇️⬇️ 重複排除+フィルタリング |
| **出力形式** | JSON | Excel | ✅ プロフェッショナルレポート |
| **並行性** | 固定10 | 動的CPU*2 | ⬆️⬆️ 適応的 |
| **I/O性能** | 直接書き込み | 256KBバッファ | ⬆️⬆️ システムコール削減 |

---

## 🔄 バージョン履歴

### v2.5.0 (2025-12-05) - 🎉 メジャーアップデート

#### 🆕 新機能
- ✨ **Excelレポート生成** - 単純なJSONに代わるプロフェッショナルなマルチシート分類レポート
- 🎯 **スマート誤検知フィルタリング** - ブラックリスト + TLD検証 + コンテキスト検出、誤検知を85%削減
- 📊 **データ重複排除** - 自動重複排除、データ量を97%削減
- 🏷️ **リスク分類** - 高/中/低リスクの自動分類
- 📍 **完全なコンテキスト** - 各エントリにファイルパスと行番号を含む

#### ⚡ パフォーマンス最適化
- 🚀 **動的並行処理** - CPUコア数に基づいてワーカー数を自動調整（以前は固定10 → CPU*2）
- 💾 **バッファI/O** - 256KBバッファでファイル読み書き性能を向上
- 🔧 **ルール事前コンパイル** - 起動時にすべての正規表現をコンパイルし、繰り返しオーバーヘッドを回避
- 📦 **ビルド最適化** - `-ldflags="-s -w"`を使用してバイナリサイズを削減

#### 🐛 バグ修正
- ドメインルールがファイル名（index.weappなど）を誤検知する問題を修正
- JavaScript APIがドメインとして誤認識される問題を修正
- ディレクトリマージ性能を最適化

#### 💡 技術的改善
- `internal/scanner`モジュールを追加（types, filter, collector, scanner）
- `internal/reporter`モジュールを追加（Excelレポート生成）
- `excelize/v2`ライブラリを使用してプロフェッショナルなExcelレポートを生成
- 完全なユニットテストカバレッジ

### v1.0.0 (2024-XX-XX)
- 🎉 初回リリース
- ✅ 基本的な解凍機能
- ✅ コード整形
- ✅ 機密情報スキャン（JSON出力）

---

## 🛠️ 技術アーキテクチャ

```
Gwxapkg/
├── cmd/
│   └── root.go           # CLIエントリ、進行状況バー、レポート生成
├── internal/
│   ├── cmd/              # コマンド処理、ファイル解析
│   ├── decrypt/          # AES+XOR復号化
│   ├── unpack/           # wxapkgバイナリ解析
│   ├── restore/          # プロジェクト構造復元
│   ├── formatter/        # コード整形（JS/CSS/HTML）
│   ├── key/              # ルール管理、事前コンパイル
│   ├── scanner/          # ⭐ NEW スキャンエンジン
│   │   ├── types.go      # データモデル
│   │   ├── filter.go     # 誤検知フィルタリング
│   │   ├── collector.go  # データ収集と重複排除
│   │   └── scanner.go    # スキャンロジック
│   ├── reporter/         # ⭐ NEW レポート生成
│   │   └── excel.go      # Excelレポート
│   ├── config/           # 設定管理
│   └── ui/               # ターミナルUI
├── config/
│   └── rule.yaml         # 200以上の機密情報ルール
└── main.go
```

---

## 🤝 貢献

貢献を歓迎します！以下の手順に従ってください：

1. このリポジトリをフォーク
2. 機能ブランチを作成（`git checkout -b feature/AmazingFeature`）
3. 変更をコミット（`git commit -m 'Add some AmazingFeature'`）
4. ブランチにプッシュ（`git push origin feature/AmazingFeature`）
5. プルリクエストを作成

---

## 📄 ライセンス

このプロジェクトはMITライセンスの下でライセンスされています - 詳細は[LICENSE](LICENSE)ファイルを参照してください

---

## ⚠️ 免責事項

このツールは教育および研究目的のみです。違法な目的で使用しないでください。このツールの使用によって生じる結果については、使用者が責任を負います。

---

## 🌟 Star履歴

このプロジェクトが役に立った場合は、⭐ Starをください！

---

<div align="center">

**Made with ❤️ by [25smoking](https://github.com/25smoking)**

</div>
